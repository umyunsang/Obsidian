
---
## 1. 전송 계층 관련 프로토콜 분석
#### TCP 헤더 분석
- 전송계층이 해야 할 일 (TCP 헤더에 모두 있음)
	![](../../../../image/Pasted%20image%2020241202153250.png)
	- 다양한 응용 프로그램들이 인터넷을 사용할 수 있는 **멀티 인터페이스**(TSAP)를 제공
	- 전송된 **데이터의 무결성**을 보장
	- 네트워크의 상태는 매우 유동적이기 때문에 이에 맞추어 **혼잡 제어**
	- 연결을 설정하는 문제와 해제하는 문제를 담당
- 전송계층이 해야 하는 대표적인 작업을 담당하는 프로토콜이 TCP(Transmission Control Protocal)
- 응용 프로그램이 소켓을 통해 인터넷으로 전달할 데이터를 보내면 TCP는 TCP 헤더를 붙여서 IP로 내려 보냄
- IP는 IP 헤더를 붙여 이더넷으로 내려 보내면 이더넷이 데이터를 전송.
	![](../../../../image/Pasted%20image%2020241202153825.png)
- TCP 헤더는 IP헤더와 마찬가지로 32비트(4바이트)를 기준으로 나눔 -> TCP 헤더의 필수 부분은 5 x 4바이트 = 20바이트, 옵션은 없을 수 있으며, 있더라도 4바이트씩 증가

![](../../../../image/Pasted%20image%2020241202154344.png)
![](../../../../image/Pasted%20image%2020241202154818.png)
- TCP를 사용하는 모든 응용 프로그램들이(process) 포트를 사용하여 구분되기 때문에 **보내는 쪽 포트**(Source Port)와 **받는 쪽 포트**(Destination Port) 둘 다 표시하여 보냄
- TCP의 구조상, 받는 쪽 포트를 알아야지만 데이터를 보낼 수 있음
	- 받는 쪽의 응용 프로그램이 웹 데몬(HTTPD)와 같이 잘 알려진 소프트웨어라면 **0에서 1023번 까지의 well-known 포트 번호**를 가지고 있음
- 포트번호의 길이는 16비트이다. 따라서 0에서 65535까지의 포트번호를 가짐
- 일반적인 응용 프로그램이라면 1024번 이상 65535이하의 임의의 값을 포트번호로 할당 받음

![](../../../../image/Pasted%20image%2020241202154835.png)
- 네트워크에서 데이터를 전송하는 과정에서 순서가 **뒤바뀌거나 사라지는 문제**가 발생.
- 데이터 전송에는 2번줄 Sequence Number(일련번호)와 3번줄 Acknowledge Number(ACK 번호)를 사용
- 일련번호와 ACK 번호는 연결을 설정하고 해제하는데도 사용
- 컴퓨터가 켜진 후 꺼질 때 까지 무수히 많은 수의 데이터를 전송하기 때문에 일련번호와 ACK 번호는 충분히 커야 함
- 일련번호와 ACK 번호에 32비트를 할당하였기 때문에 0부터 $2^{32}$ - 1까지, **약 42억개의 번호**를 사용 할 수 있음.

![](../../../../image/Pasted%20image%2020241202154855.png)
- **THL** : THL은 TCP Header Length의 약자. **옵션을 포함한 TCP 헤더 길이**를 나타냄. 데이터는 포함 되지 않음. THL 필드에 들어 있는 값은 4 바이트 단위의 줄의 길이를 의미. 따라서 **옵션이 없는 경우에는 THL에는 5**가 들어 있음.
- ==**ECE**== : IP 헤더에서 ECN필드와 연동되는 필드가 ECE. ECE는 ECN-Echo로 부름. IP 헤더에서 ECN은 **혼잡제어**에 사용되며, 네트워크에 혼잡이 발생 하여 패킷이 제대로 전달되지 않을 경우 활성화 됨(ECE가 1). 
	- ECE를 ECN-Echo라 부르는 이유는 IP의 ECN이 네트워크가 혼잡하여 윈도우 크기를 줄인다고 결정하면, TCP의 ECE가 1로 바뀌기 때문.
	- 윈도우 크기를 줄여 혼잡을 완화하는 작업은 TCP에서 이루어지지만 라우터의 혼잡한 상태를 확인 할 수 있는 것은 네트워크 계층.
- ==**CWR**== : CWR은 Congestion Window Reduced의 약자로 ECE를 받아 윈도우 크기를 줄였다는 것을 **확인하는 필드**. 또한 ECE를 중복적으로 보내지 않아도 된다는 의미.
- **URG** : URG는 Urgent의 약자로 긴급하게 처리해야 할 데이터가 있는 경우 1이 됨.
- ==**ACK**== : TCP 헤더의 ACK 번호가 의미가 있는 경우 ACK가 1이 됨. ACK가 0이면 ACK 번호는 무시. (TCP는 무조건 1)
- **PSH** : PSH는 push를 의미. **PSH 필드가 1이 되면**, **순서가 맞지 않아도 버퍼에 있는 데이터를 응용 계층으로 무조건 올려 보냄**.
- **SYN** : SYN는 Synchronize를 의미하며 **연결 설정에 사용**되는 Connection Request(CR)을 의미. 연결을 설정할 때 SYN 필드가 1이 됨.
- **FIN** : FIN은 Finalize를 의미하며 **연결 해제에 사용**되는 Disconnection Request(DR)을 의미. 연결을 해제 할 때 FIN 필드가 1이 됨.
- **RST** : RST는 Reset을 의미한다. 연결 설정이나 연결 해제가 원만히 이루어지지 않을 경우 RST는 필드를 1로 만들면 **리셋하자는 의미**.
- **Window Size** : 슬라이딩 윈도우 프로토콜의 **윈도우 크기**(ACK없이 받을 수 있는 데이터 크기)를 나타냄. 윈도우의 크기 필드가 16비트 이기 때문에 윈도우의 최대 크기(ACK 없이 보낼 수 있는 데이터의 개수)는 65536($2^{16}$)개. 

![](../../../../image/Pasted%20image%2020241202154911.png)
- **Checksum** : 에러 검사 코드인 체크썸Checksum이 들어 있으며 크기는 16비트. **TCP의 체크썸은 헤더와 데이터 모두 검사**.
- **Urgent Pointer** : Urgent Pointer는 4번 줄 **URG(Urgent)가 1이 되면** 의미가 생기는 필드. 통신을 하던 중 **긴급하게 처리해야 하는 데이터가 있다면**, URG가 1이 됨. URG가 1이 된 경우, 데이터 중 긴급하게 처리 되어야 하는 위치(주소)를 Urgent Pointer가 가지고 있음.
#### UDP
- TCP의 작업은 부담스러운 경우를 위해 만든 프로토콜이 UDP, 영어로 User Datagram Protocol.
- 안정성보다는 **속도나 실시간**을 요구하는 네트워크 통신에는 UDP/IP를 사용.
- UDP 헤더
	![](../../../../image/Pasted%20image%2020241204170450.png)
	- 1번 줄은 TCP 헤더와 마찬가지로 보내는 쪽 포트(Source Port)와 받는 쪽 포트(Destination Port).
	- 2번줄 **UDP Length**는 **데이터를 포함한 UPD의 전체 길이**를 나타냄. 표시 단위는 바이트. 
	- 헤더를 포함한 UDP 전체에 대하여 에러검출 코드로 체크썸을 사용.
#### RTP(4.5 계층)
![](../../../../image/Pasted%20image%2020241204171107.png)
- RTP는 스트리밍 데이터의 전송을 위해 설계된 **실시간 전송 프로토콜**
- 주로 동영상 스트리밍, 화상통신과 같은 멀티미디어 통신에 사용
- TCP나 UDP는 운영체제가 인터넷을 사용하는 응용 프로그램에게 제공하는 통신 서비스
- RTP는 UDP를 사용하여 빠르게 데이터를 전송하도록 설계된 것으로 응용 프로그램이 자체적으로 사용
- RTP의 또 다른 특징은 다양한 비디오 및 오디오 포맷을 지원하기 위하여 헤더에서 기능을 추가하거나 뺄 수 있도록 설계.
- RTP는 **지터 보상, 패킷 손실, 느린 전송 감지** 기능들을 제공.
- RTP는 **일 대 일 통신 뿐 아니라 멀티캐스트**를 통해 여러 곳에 데이터를 전송할 수 있게 해 줌.

![](../../../../image/Pasted%20image%2020241204172056.png)
- 옵션을 제외한 RTP 헤더의 기본 크기는 3줄(12바이트)이다. 헤더의 옵션은 4바이트 단위로 증가. 
- ver (version): RTP 버전 번호이며 현재는 2. 
- P (padding): RTP 마지막에 **패딩 데이터**가 존재하는 경우 1이 되는 필드. 
- x (extention): RTP 헤더의 마지막에 RTP Header extention이 존재하는 경우 1이 됨.
- **CC** (CSRC Count): RTP에서 발신자를 구분하는 고유번호는 3번 줄의 SSRC(주전송자)임. 발신자가 여러 개인 경우 CSRC(보조 전송자)가 붙음. CSRC는 1개에서 N(16)개까지 사용할 수 있는데 CC 는 CSRC의 개수를 나타냄.
- M (marker): 마커는 응용프로그램이 필요할 때 사용할 수 있는 필드.
- **payload type** : 헤더 다음에 이어지는 데이터의 종류를 나타낸다. 사진, 음악, 동영상과 관련된 각 종 인코딩 데이터가 표시 됨.
- **Sequence number** : RTP는 UDP를 기반으로 만들어졌기 때문에 패킷이 손실될 수 있음. Sequence number는 패킷의 손실이나 순서가 뒤바뀌는 경우를 확인하기 위해서 만들어진 필드.
- Timestamp: 데이터의 생성시간을 나타냄.
- RTP는 RTCP(RTP Control Protocol)와 결합하여 사용.
#### 혼잡제어
- 혼잡제어를 위해서 TCP에서는 ECE와 CWR 필드가 사용되고 IP에서는 ECN이 사용됨.
- 혼잡제어를 위해서는 TCP의 연결설정 단계에서 양쪽이 ECN을 사용할 것인지를 합의해야 함.
	![](../../../../image/Pasted%20image%2020241204172926.png)
	- 혼잡제어를 사용을 원하는 호스트 A는 연결설정에서 SYN, CWR, ECE 필드를 1로 만들어 보냄 -> 이를 받은 호스트 B는 혼잡제어에 동의 할 경우 SYN, ACK, ECE 필드를 1로 만들어 보냄.
	![](../../../../image/Pasted%20image%2020241204173050.png)
	- 만약 호스트 B가 혼잡제어가 필요 없다고 판단되는 경우에는 SYN, ACK만 보낸다. 이 경우 혼잡제어는 무시.

![](../../../../image/Pasted%20image%2020241204173203.png)
- 양쪽이 혼잡제어에 동의하는 경우. 
- TCP의 윈도우 크기를 줄이도록 결정하는 것은 IP의 ECN 필드, ECN은 ECT비트와 CE 비트 두 개로 구성 -> ECN 필드가 (0, 0)으로 설정되면 혼잡제어를 안 한다는 의미 -> (0, 1) 혹은 (1, 0)으로 설정되면 라우터에게 혼잡제어를 하라는 의미(ECT 상태). 
- 라우터에서 혼잡이 발견되면 라우터는 받는 쪽(호스트 B)로 ECN 필드를 (1, 1)로 만들어 보냄(CE 상태) -> 호스트 B는 TCP의 ECE를 1로 만들어 호스트 A에게 보냄 -> ECE를 받은 호스트 A는 슬라이딩 윈도우의 크기를 줄이고, ECE에 대한 확인으로 CWR을 1로 만들어 보냄.
---