
---
## 1. 스레드 동기화의 필요성
#### 스레드 동기화의 필요성
- 다수의 스레드가 동시에 공유 데이터에 **쓰기**를 접근하면 
	- 공유데이터가 훼손되는 문제 발생 가능 
		- 두 스레드가 동시에 공유 데이터 읽는 경우 -> 문제 없음 
		- 한 스레드는 쓰고 한 스레드는 읽을 경우 -> 읽고 쓰는 순서에 따라 읽는 값이 달라질 수 있지만 공유데이터의 훼손은 없음 
		- **두 스레드가 동시에 공유 데이터에 쓰는 경우 -> 공유 데이터 훼손 가능성** 
	- 예) 회원의 은행 회비 계좌에 대한 동시 접근 은행의 서버 컴퓨터에 100만원이 있는 공동 계좌가 있을 때, 2명이 동시에 100만원씩 입금하면, 두 스레드가 동시에 계좌에 100만원씩 더하기 실행. 300만원이 되어야 하는데, 만일 잔액이 200만원이 된다면! 
- 스레드 동기화(thread synchronization) 
	- 공유데이터에 대한 다수의 스레드가 동시에 접근할 때 공유데이터가 훼손되지 않게 하는 기법 
		- 한 스레드가 공유데이터를 배타적 독점적으로 접근하도록 순서화

#### 공유 집계판 사례의 코드 모델
- 두 학생 : 스레드 T1, T2 
- 공유 집계판 : 공유 변수 sum 
- 계산 식 : sum = sum + 10;

![[Pasted image 20241014091635.png]]
- mov ax, sum ; sum 변수 값을 읽어 ax 레지스터에 저장 
- add ax, 10 ; ax 레지스터 값 10증가 
- mov sum, ax ; ax 레지스터 값을 sum 변수에 저장

![[Pasted image 20241014091954.png]]
- 문제점 
	- 여러 스레드가 공유 변수에 접근할 때, 공유 데이터 훼손 
- 해결책 - 스레드 동기화 
	- 한 스레드가 공유 데이터 사용을 마칠 때까지, 
	- 다른 스레드가 공유 데이터에 접근하지 못하도록 제어 
- 멀티스레드의 경쟁 상황이 자주 발생하는가? 
	- 매우 자주 발생 
		- 사용자의 멀티스레드 프로그램에서 자주 발생 
		- 커널 코드에서 매우 자주 발생 
			- 커널에 공유 데이터가 많기 때문 
	- 다중 코어에서 더욱 조심
#### 임계구역과 상호배제
- 스레드 동기화와 관련된 2가지 중요 개념 : 임계구역과 상호배제 
- **임계구역(critical section)** 
	- 공유 데이터에 접근하는 프로그램 코드들 
- 상호배제(mutual exclusion) 
	- 임계구역을 오직 한 스레드만 배타적 독점적으로 사용하도록 하는 기술 
		- 임계구역에 먼저 진입한 스레드가 임계구역의 실행을 끝낼 때까지, 
		- 다른 스레드가 진입하지 못하도록 보장

![[Pasted image 20241014094057.png]]

## 2. 상호 배제(mutual exclusion)
#### 상호 배제를 포함하는 전형적인 프로그램
![[Pasted image 20241014094537.png]]
1. 일반 코드(non-critical code) 
	-  공유 데이터를 액세스하지 않는 코드 
2. **임계구역 진입 코드(entry code)** 
	-  임계구역에 진입하기 전 필요한 코드 블록 
	-  현재 임계구역을 실행 중인 스레드가 있는 지 검사 
		-  없다면, 다른 스레드가 들어오지 못하도록 조치 
		-  있다면, 진입이 가능해질 때까지 대기 
3. 임계구역 코드(critical code) 
4. **임계구역 진출 코드(exit code)** 
	-  임계구역을 마칠 때 필요한 코드 블록 
	-  대기중인 스레드가 임계구역에 진입할 수 있도록, 진입 코드에서 취한 조치 해제 
#### 상호배제 구현
- 상호배제 구현 목표 
	- 임계구역에 오직 1개의 스레드만 진입 
- 상호배제 구현 방법 
	- 소프트웨어적 방법 - Peterson's 알고리즘 등, 설명 생략 
		- 알고리즘 수준에서 제시된 것들로 구현 시 여러 문제 노출 
	- 하드웨어적 방법 – 하드웨어의 도움을 받는 방법 
		- 인터럽트 서비스 금지, 원자 명령 활용 등 
		- 오늘날 대부분 하드웨어적 방법 사용 

#### 하드웨어적 방법 
- **방법 1 - 인터럽트 서비스 금지** 
	- entry 코드에서 인터럽트 서비스를 금지하는 명령 실행
		- 장치로부터 인터럽트가 발생해도, CPU가 인터럽트 발생을 무시 
		- 인터럽트가 발생해도 CPU는 인터럽트 서비스 루틴을 실행하지 않음 
		- 인터럽트를 무시하면 임계구역을 실행하는 스레드가 중단되지 않음
	- 문제점 
		- 모든 인터럽트가 무시되는 문제 발생 
		- 멀티 코어 CPU나 다중 CPU를 가진 시스템에서 활용 불가 
- **방법 2 - look 변수로 상호배제 시도**
	- locking/unlocking 방식으로 임계구역의 entry/exit 코드 작성하면 상호배제가 가능할까?
		![[Pasted image 20241014100346.png]]
		- lock 변수 : 1이면 잠금 상태 
		- lock 변수 : 0이면 열린 상태
	- lock 변수를 이용한 상호배제의 실패 원인? 
		- 실패 원인은 entry 코드에 있음 
		- lock 변수 값을 읽는 명령과 lock 변수에 1을 저장하는 2개의 명령 사이에 컨텍스트 스위칭이 될 때 문제 발생
			![[Pasted image 20241014100049.png]]
- **방법 3 - 원자 명령(atomic instruction) 사용** 
	- lock 변수를 읽어 들이는 명령과 lock 변수에 1을 저장하는 2개의 명령을 한 번에 처리하는 원자명령 필요 
	- **원자명령 : TSL(Test and Set Lock)**
		![[Pasted image 20241014100455.png]]
